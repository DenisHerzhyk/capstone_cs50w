{% extends 'polls/layout.html' %} {% block content %}
<div
  class="mx-auto px-4 sm:px-6 lg:px-8 flex flex-col items-center justify-center mt-8"
>
  <h1 class="text-center text-3xl mb-10 underline decoration-blue-400">
    Image Converter
  </h1>
  <div
    id="drop-area"
    class="w-full max-w-xl border-4 border-dashed border-gray-300 p-8 mb-4 bg-white rounded text-center"
  >
    <p class="mb-2 text-gray-600">
      Drag and drop images here or click the button to select files
    </p>
    <input
      type="file"
      id="fileElem"
      class="hidden"
      multiple
      accept="image/*,application/pdf"
      onchange="handleFiles(this.files)"
    />
    <button
      class="bg-red-500 text-white px-4 py-2 rounded"
      onclick="document.getElementById('fileElem').click()"
    >
      Select from device
    </button>
    <ul id="file-list" class="file-list mt-4"></ul>
  </div>
  <button
    id="generate-pdf"
    name="action"
    value="generate-pdf"
    class="bg-blue-400 text-black px-4 py-2 rounded mb-4 min-w-[200px]"
    onclick="generatePDF()"
  >
    <div class="flex flex-row gap-2 justify-center items-center">
      <img src="../../../static/images/pdf.png" class="w-6 h-6" alt="pdf" />
      Generate PDF
    </div>
  </button>
  <div id="pdf_pages" class="hidden"></div>
  <button
    id="generate-tiff"
    name="action"
    value="generate-tiff"
    class="bg-blue-400 text-black px-4 py-2 rounded mb-4 min-w-[200px]"
    onclick="generateTIFF()"
  >
    <div class="flex flex-row gap-2 items-center justify-center">
      <img src="../../../static/images/tiff.png" class="w-6 h-6" alt="tiff" />
      Generate TIFF
    </div>
  </button>
  <button
    id="generate-png"
    name="action"
    value="generate-png"
    class="bg-blue-400 text-black px-4 py-2 rounded mb-4 min-w-[200px]"
    onclick="generatePNG()"
  >
    <div class="flex flex-row gap-2 justify-center items-center">
      <img src="../../../static/images/png.svg" class="w-6 h-6" alt="png" />
      Generate PNG
    </div>
  </button>
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />
</div>
<script>
  let files = [];

  const handleFiles = (selectedFiles) => {
    const fileList = document.getElementById("file-list");
    fileList.innerHTML = "";

    for (let i = 0; i < selectedFiles.length; i++) {
      files.push(selectedFiles[i]);
      const li = document.createElement("li");
      li.textContent = selectedFiles[i].name;
      fileList.appendChild(li);
    }
  };

  const generate = (input_name, err) => {
    if (files.length === 0) {
      alert("Please select at least one image!");
      return;
    }

    const csrfToken = document.querySelector(
      "[name=csrfmiddlewaretoken]",
    ).value;
    const formData = new FormData();
    formData.append("action", input_name);
    files.forEach((file, index) => {
      formData.append("files[]", file);
    });

    fetch("/upload/", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        console.log(data.success);
        if (data.success) {
          window.location.href = "/file_generation_in_progress";
        } else {
          alert(err);
          console.log(data.error);
        }
      })
      .catch((msg) => {
        alert(err);
        console.log("Error: ", msg);
      });
  };

  const generatePDF = () => {
    if (files.length === 0) {
      alert("Please select at least one image!");
      return;
    }

    const formData = new FormData();
    formData.append("action", "pdf_edit");
    files.forEach((file, index) => {
      formData.append("file", file);
    });

    fetch("/upload-edit/", {
      method: "POST",
      body: formData,
      headers: {
        "CSRF-Token": document.querySelector("[name=csrfmiddlewaretoken]")
          .value,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        const pdf_pages_block = document.getElementById("pdf_pages");
        pdf_pages_block.innerHTML = "";
        pdf_pages_block.className = "flex";
        // pdf_pages_block.classList.add = "flex";

        data.files.forEach((file) => {
          var div = document.createElement("div");

          div.innerHTML = `<strong>${file.name} - [${file.pages}]</strong>`;
          pdf_block.append(div);
        });
      });
    // generate("generate-pdf", "Error generating PDF");
  };

  const generateTIFF = () => {
    generate("generate-tiff", "Error generating TIFF");
  };

  const generatePNG = () => {
    generate("generate-png", "Error generating PNG");
  };

  document.getElementById("drop-area").addEventListener("dragover", (e) => {
    e.preventDefault();
    e.stopPropagation();
    e.dataTransfer.dropEffect = "copy";
  });
  document.getElementById("drop-area").addEventListener("drop", (e) => {
    e.preventDefault();
    e.stopPropagation();
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
  });
</script>

{% endblock content %}
